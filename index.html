<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUFFERFISH // VAULT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700;900&display=swap');
        body { background: #050507; color: #fff; font-family: 'Outfit', sans-serif; overflow: hidden; }
        .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.05); }
        .neon-shadow { box-shadow: 0 0 20px rgba(0, 242, 255, 0.2); }
        .hidden { display: none; }
    </style>
</head>
<body class="h-screen flex items-center justify-center">

    <div id="auth-screen" class="glass p-10 rounded-[40px] w-96 text-center neon-shadow">
        <i class="fa-solid fa-fish-fins text-5xl text-cyan-500 mb-6"></i>
        <h1 class="text-2xl font-black mb-6 uppercase tracking-widest">Vault Login</h1>
        <div class="space-y-4">
            <input id="email" type="email" placeholder="E-Mail" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none focus:border-cyan-500 transition">
            <input id="password" type="password" placeholder="Passwort" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none focus:border-cyan-500 transition">
            <button onclick="handleLogin()" class="w-full bg-cyan-500 text-black font-black py-4 rounded-2xl hover:bg-cyan-400 transition">ENTRANCE</button>
            <button onclick="handleRegister()" class="text-xs text-gray-500 hover:text-white transition">Noch kein Account? Registrieren</button>
        </div>
    </div>

    <div id="main-ui" class="hidden w-full h-full flex">
        <aside class="w-72 bg-black/40 border-r border-white/5 flex flex-col p-6">
            <div class="flex items-center space-x-3 mb-12">
                <div class="w-10 h-10 bg-cyan-500 rounded-xl flex items-center justify-center"><i class="fa-solid fa-vault text-black"></i></div>
                <span class="text-xl font-black italic">PUFFER_VAULT</span>
            </div>
            <nav class="flex-1 space-y-2">
                <button onclick="setView('private')" class="w-full p-4 rounded-2xl flex items-center space-x-4 bg-cyan-500/10 text-cyan-400 border border-cyan-500/20">
                    <i class="fa-solid fa-lock"></i><span class="font-bold text-sm">Privat</span>
                </button>
                <button onclick="setView('public')" class="w-full p-4 rounded-2xl flex items-center space-x-4 hover:bg-white/5 text-gray-500 transition">
                    <i class="fa-solid fa-globe"></i><span class="font-bold text-sm">Öffentlich</span>
                </button>
            </nav>
            <div class="p-4 glass rounded-3xl">
                <div class="flex justify-between text-[10px] font-bold mb-2"><span>STORAGE</span><span id="perc">0%</span></div>
                <div class="h-1.5 bg-black rounded-full overflow-hidden"><div id="bar" class="h-full bg-cyan-500 w-0 transition-all"></div></div>
            </div>
            <button onclick="handleLogout()" class="mt-4 text-[10px] text-red-500 font-bold uppercase tracking-widest">Disconnect</button>
        </aside>

        <main class="flex-1 flex flex-col">
            <header class="h-24 border-b border-white/5 flex items-center px-10 justify-between">
                <h2 id="title" class="text-2xl font-black uppercase">My Safe</h2>
                <div class="flex items-center space-x-4">
                    <button onclick="document.getElementById('file-in').click()" class="bg-white text-black font-black px-6 py-2 rounded-xl text-sm">UPLOAD</button>
                    <input type="file" id="file-in" class="hidden" onchange="uploadFile(this.files[0])">
                </div>
            </header>
            <div id="grid" class="p-10 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6 overflow-y-auto"></div>
        </main>
    </div>

    <script src="db.js"></script>
    <script>
        const supabase = window.supabaseClient;
        let user = null;
        let currentView = 'private';

        // --- AUTH LOGIC ---
        async function handleLogin() {
            const { data, error } = await supabase.auth.signInWithPassword({
                email: document.getElementById('email').value,
                password: document.getElementById('password').value
            });
            if(error) alert(error.message); else checkUser();
        }

        async function handleRegister() {
            const { data, error } = await supabase.auth.signUp({
                email: document.getElementById('email').value,
                password: document.getElementById('password').value
            });
            if(error) alert(error.message); else alert("Check deine E-Mails zum Bestätigen!");
        }

        async function handleLogout() {
            await supabase.auth.signOut();
            location.reload();
        }

        async function checkUser() {
            const { data } = await supabase.auth.getUser();
            if(data?.user) {
                user = data.user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-ui').classList.remove('hidden');
                loadFiles();
                updateStorage();
            }
        }

        // --- FILE LOGIC ---
        async function loadFiles() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '<p class="text-cyan-500 animate-pulse">Syncing...</p>';
            
            let query = supabase.from('vault_files').select('*');
            query = (currentView === 'private') ? query.eq('owner_id', user.id) : query.eq('is_public', true);
            
            const { data } = await query.order('created_at', { ascending: false });
            grid.innerHTML = '';
            
            data?.forEach(f => {
                const div = document.createElement('div');
                div.className = "glass p-4 rounded-3xl border border-white/5 hover:border-cyan-500 transition group";
                div.innerHTML = `
                    <div class="h-24 bg-white/5 rounded-2xl mb-3 flex items-center justify-center text-2xl opacity-30 group-hover:opacity-100 group-hover:text-cyan-500"><i class="fa-solid fa-file"></i></div>
                    <p class="text-xs font-bold truncate">${f.name}</p>
                    <div class="flex justify-between items-center mt-3">
                        <span class="text-[9px] text-gray-600">${(f.size/1024/1024).toFixed(1)}MB</span>
                        <div class="flex space-x-2">
                            <a href="${f.url}" download="${f.name}" target="_blank" class="text-cyan-500 text-xs"><i class="fa-solid fa-download"></i></a>
                            ${currentView === 'private' ? `<button onclick="makePublic('${f.id}', ${f.is_public})" class="text-xs ${f.is_public ? 'text-green-500' : 'text-gray-700'}"><i class="fa-solid fa-share"></i></button>` : ''}
                        </div>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        async function uploadFile(file) {
            if(!file) return;
            const path = `${user.id}/${Date.now()}_${file.name}`;
            const { data, error } = await supabase.storage.from('vault').upload(path, file);
            if(error) return alert(error.message);

            const { data: url } = supabase.storage.from('vault').getPublicUrl(path);
            
            await supabase.from('vault_files').insert([{
                owner_id: user.id, name: file.name, size: file.size, url: url.publicUrl, is_public: false
            }]);

            loadFiles();
            updateStorage();
        }

        async function updateStorage() {
            // Hier ziehen wir die Summe aller Files des Users
            const { data } = await supabase.from('vault_files').select('size').eq('owner_id', user.id);
            const total = data.reduce((acc, curr) => acc + curr.size, 0);
            const gb = (total / (1024**3)).toFixed(2);
            const perc = (total / (10 * 1024**3) * 100).toFixed(1);
            document.getElementById('perc').innerText = perc + "%";
            document.getElementById('bar').style.width = perc + "%";
        }

        async function makePublic(id, state) {
            await supabase.from('vault_files').update({ is_public: !state }).eq('id', id);
            loadFiles();
        }

        function setView(v) {
            currentView = v;
            document.getElementById('title').innerText = v === 'private' ? 'My Safe' : 'Public Hub';
            loadFiles();
        }

        checkUser();
    </script>
</body>
</html>
