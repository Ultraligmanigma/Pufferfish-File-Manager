<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>PUFFERFISH // THE PIT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;900&display=swap');
        body { background: #020202; color: #fff; font-family: 'Outfit', sans-serif; overflow: hidden; }
        .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.05); }
        .neon-purple { color: #a855f7; text-shadow: 0 0 15px rgba(168, 85, 247, 0.5); }
        .crash-anim { animation: shake 0.1s infinite; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -1px); } 100% { transform: translate(1px, -1px); } }
        .btn-glow { box-shadow: 0 0 30px rgba(168, 85, 247, 0.2); transition: 0.3s; }
        .btn-glow:hover { box-shadow: 0 0 50px rgba(168, 85, 247, 0.5); transform: scale(1.02); }
    </style>
</head>
<body class="h-screen flex">

    <aside class="w-80 bg-black/50 border-r border-white/5 p-8 flex flex-col">
        <div class="mb-12">
            <h1 class="text-2xl font-black italic tracking-tighter neon-purple uppercase">Puffer_Pit</h1>
            <p class="text-[10px] text-gray-500 font-bold tracking-[0.3em]">PROVABLY FAIR GAMBLING</p>
        </div>

        <div class="glass p-6 rounded-[32px] mb-8">
            <p class="text-[10px] text-gray-500 font-black mb-1 uppercase">Your Balance</p>
            <div class="text-3xl font-black flex items-center space-x-2">
                <span id="balance-display">1.000</span>
                <i class="fa-solid fa-coins text-yellow-500 text-sm"></i>
            </div>
        </div>

        <div class="flex-1 space-y-4">
            <div class="text-[10px] text-gray-500 font-black uppercase tracking-widest">Live Bets</div>
            <div id="bet-history" class="space-y-2 overflow-y-auto max-h-[400px] pr-2">
                </div>
        </div>

        <button onclick="logout()" class="text-[10px] text-gray-600 font-black uppercase hover:text-white transition">Disconnect</button>
    </aside>

    <main class="flex-1 flex flex-col items-center justify-center p-20 relative">
        
        <div id="game-zone" class="text-center">
            <div id="status-label" class="text-sm font-black text-gray-500 uppercase tracking-[0.5em] mb-4">Multiplier</div>
            <div id="multiplier" class="text-[12rem] font-black leading-none tracking-tighter transition-all">1.00x</div>
        </div>

        <div class="mt-20 w-full max-w-md space-y-4">
            <div class="relative">
                <input id="bet-amount" type="number" value="100" class="w-full bg-white/5 border border-white/10 p-6 rounded-3xl text-2xl font-black text-center outline-none focus:border-purple-500 transition">
                <span class="absolute right-6 top-1/2 -translate-y-1/2 text-gray-500 font-bold">PTS</span>
            </div>
            
            <button id="action-btn" onclick="handleAction()" class="w-full bg-purple-600 text-white py-8 rounded-[35px] text-xl font-black uppercase tracking-widest btn-glow">
                Place Bet
            </button>
        </div>

        <div id="message" class="mt-8 font-bold text-purple-400 h-6"></div>
    </main>

    <script src="db.js"></script>
    <script>
        let balance = 1000;
        let currentMultiplier = 1.00;
        let gameRunning = false;
        let isCrashed = false;
        let hasBet = false;
        let betAmount = 0;
        let gameInterval;
        let user = null;

        async function init() {
            const { data } = await supabase.auth.getUser();
            if(!data.user) { window.location.href = 'login.html'; return; }
            user = data.user;
            balance = await getBalance(user.id);
            updateUI();
        }

        function updateUI() {
            document.getElementById('balance-display').innerText = balance.toLocaleString();
        }

        function handleAction() {
            if (!gameRunning && !isCrashed) {
                startBet();
            } else if (gameRunning && hasBet) {
                cashOut();
            }
        }

        function startBet() {
            const input = document.getElementById('bet-amount');
            betAmount = parseInt(input.value);

            if (betAmount > balance || betAmount <= 0) return alert("Invalid Balance!");

            balance -= betAmount;
            hasBet = true;
            gameRunning = true;
            updateBalance(user.id, balance);
            updateUI();

            document.getElementById('action-btn').innerText = "CASH OUT";
            document.getElementById('action-btn').classList.replace('bg-purple-600', 'bg-green-600');
            
            runGame();
        }

        function runGame() {
            currentMultiplier = 1.00;
            isCrashed = false;
            const crashPoint = (Math.random() * 5 + 1).toFixed(2); // ZufÃ¤lliger Crash zwischen 1 und 6

            gameInterval = setInterval(() => {
                currentMultiplier += 0.01;
                document.getElementById('multiplier').innerText = currentMultiplier.toFixed(2) + "x";

                if (currentMultiplier >= crashPoint) {
                    crashGame();
                }
            }, 50);
        }

        function cashOut() {
            const win = Math.floor(betAmount * currentMultiplier);
            balance += win;
            hasBet = false;
            
            document.getElementById('message').innerText = `WON: +${win} PTS`;
            document.getElementById('message').style.color = "#22c55e";
            
            updateBalance(user.id, balance);
            updateUI();
            
            // User bleibt im Spiel, kann aber nicht mehr cashen
            document.getElementById('action-btn').innerText = "WAITING...";
            document.getElementById('action-btn').disabled = true;
        }

        function crashGame() {
            clearInterval(gameInterval);
            gameRunning = false;
            isCrashed = true;
            
            document.getElementById('multiplier').classList.add('text-red-600', 'crash-anim');
            document.getElementById('status-label').innerText = "CRASHED";
            document.getElementById('status-label').classList.replace('text-gray-500', 'text-red-500');

            if (hasBet) {
                document.getElementById('message').innerText = "LOST BET";
                document.getElementById('message').style.color = "#ef4444";
            }

            setTimeout(() => {
                resetGame();
            }, 3000);
        }

        function resetGame() {
            currentMultiplier = 1.00;
            isCrashed = false;
            hasBet = false;
            document.getElementById('multiplier').innerText = "1.00x";
            document.getElementById('multiplier').classList.remove('text-red-600', 'crash-anim');
            document.getElementById('status-label').innerText = "Multiplier";
            document.getElementById('status-label').classList.replace('text-red-500', 'text-gray-500');
            document.getElementById('message').innerText = "";
            document.getElementById('action-btn').innerText = "PLACE BET";
            document.getElementById('action-btn').disabled = false;
            document.getElementById('action-btn').className = "w-full bg-purple-600 text-white py-8 rounded-[35px] text-xl font-black uppercase tracking-widest btn-glow";
        }

        init();
    </script>
</body>
</html>
